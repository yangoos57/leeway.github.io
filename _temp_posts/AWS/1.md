### AWS 소규모 프로젝트 공개 IPv4 비용 줄이기

### 작성배경

이글은 공개 IPv4 비용이 들지 않고, 소규모 프로젝트에 적합한 AWS 아키텍쳐를 소개합니다. 24년 2월 1일부로 IPv4 하나 당 월 3.8불의 비용이 부과되는 과금 정책이 적용됐습니다. 저 같은 경우 클라우드프론트, EC2, ALB, RDS, S3로 구축된 사이트를 프리티어 범위내로 사용중에 있었는데, 정책이 변경됨에 따라 3개의 IPv4에 대해 월 14달러의 비용을 지불해야했습니다. 간단한 아키텍쳐 변경만으로 불필요한 비용을 줄일 수 있었기에 저와 비슷한 고민을 하신 분들에게 이를 공유하고자 합니다.

### 과거 아키텍쳐와 현재 아키텍쳐

#### 과거 아키텍쳐

기존에 구축했던 아키텍처에 대해서 먼저 말씀드리겠습니다. 소규모 서비스를 운영하고 있다 보니 HTTPs 연결이 필수였고, 서비스와 연결 된 DB를 로컬에서도 사용해야하므로 로컬에서도 RDS가 접근 가능한 구조가 필요했습니다.

HTTPs 적용의 경우에는 과금 정책이 반영되기 전 기준으로 두가지 방법이 있었는데, 하나는 로드 밸런스를 이용하는 것이고 다른 하나는 클라우드프론트를 이용하는 것이었습니다. 당시에는 클라우드프론트로 HTTPs 연결을 하는데 있어 캐쉬 정책이나, 클라우드프론트에 기존 연결되어있던 S3와의 연결 구조 개선 등 고려사항이 많았기 때문에 빠르고 간단히 적용가능했던 로드 밸런스를 택했습니다.

RDS를 로컬에서 이용하는 방법은 간단했습니다. 서비스 자체에서 공개 IP 연결을 지원하고 있기 때문에 이를 이용하여 로컬에 접속하고 EC2에서도 공개 IP를 이용하는 방식으로 구현했습니다.

이렇게 아키텍처를 구성하면 공개 IP는 EC2 1개, 로드밸런서 2개, RDS 1개 총 네 개를 사용하게 됩니다. 그 중 EC2의 IP는 프리티어 범위에 속하므로 총 3개 IPv4에 비용을 내야하는데, 이는 월 14불 정도 됩니다.

이미지

> 현재 사용하고 있는 서비스에서 공개 IP를 얼마나 사용하고 있는지 알고싶다면, `VPC IP Address Manager`를 검색해 이용하시면 됩니다. 서비스 비용은 무료이고 monitoring 항목 -> Public IP insights 항목에서 아래와 같이 확인 가능합니다.
> 사용중인 IPv4 개수 확인하기
>
> <이미지>
>
> 참고사항으로는, 최초 기능 신청 시 약 2~30 분의 수집 시간 걸린다는 점, 서비스 변경에 따른 IPv4 변동 사항은 약 하루에서 이틀 정도 텀을 두고 업데이트 된다는 점입니다. 그러므로 서비스에서 공개 IP를 제거 하더라도 VPC IP Address Manager 내에서 반영되기까지 시간이 걸린다는 점 미리 염두에 두시기 바랍니다.

### 현재 아키텍쳐

현재 적용한 아키텍처는 공개 IPv4를 제거하되 기능은 유지하는 것을 목적으로 했습니다. HTTPs 연결 구조는 클라우드프론트로 로드 밸런스를 대체했고, RDS의 로컬 연결은 공개 IPv4를 제거하고 RDS를 EC2 다이렉트로 연결한 뒤 SSH 터널을 이용해서 받아 오는 식으로 변경했습니다.

로드 밸런스를 대체한 이유는 로드 밸런서에서 순수 IPv6 연결을 지원하지 않기 때문입니다. 이번 반영 된 정책의 목적이 공개 IPv6 사용을 권장하는 것이다보니 IPv6 이용에 대해서는 여전히 무료로 이용 가능했습니다. 초기 아키텍처를 고민할 때 클라우드프론트를 고민하기 보다는 로드 밸런서 연결을 순수 IPv6 연결하는 방식으로 우선 고민했습니다. 하지만 로드 밸런스의 옵션 자체에서 순수 IPv6 로드밸런서를 지원하지 않으므로(순수 IPv4 사용 또는 IPv4, IPv6 듀얼 연결만 가능) 무료로 사용하는 것은 불가한 것으로 판단했습니다.

이 아키텍처를 사용한다면 프리티어로 제공되는 EC2 IPv4 하나만을 사용하게 되어 IPv4에 대한 비용이 발생하지 않습니다. 로드 벨런스를 대체한 클라우드프론트는 글로벌 서비스이므로 공개 IP를 할당 받지 않기 때문에 무료로 이용 가능하며, 그외 추가 비용도 발생하지 않습니다.

이미지

### 클라우드프론트에 EC2와 S3 연결하기

먼저 클라우드프론트를 이용해 EC2에 HTTPS 연결을 하는 방법을 설명하겠습니다. 많은 분들이 S3와 클라우드프론트를 연결하는 방법에 대해서는 잘 알고 계시고, 이와 관련한 자료도 찾기 쉬운 반면, S3와 EC2를 클라우드프론트에 동시에 연결해서 사용하는 방법을 설명하는 글은 많지 않아 이 부분을 중점적으로 소개하고자 합니다.

EC2를 생성하는 방법이나 S3와 클라우드프론트를 연결하는 방법은 아래의 링크에서 상세히 설명하고 있으므로 이 분들의 글을 참고하시기 바랍니다.

#### EC2와 클라우드프론트 연결하여 HTTPS 사용하기

```
주의 HTTPs 연결에 Cloudf front를 꼭 사용해야하는 것은 아닙니다. Let's Encrypt에서 무료로 제공하는 SSL 인증서를 활용해 서버차원에서 HTTPs를 구현 가능합니다.
FastApi를 사용중이라면 https://medium.com/@mariovanrooij/adding-https-to-fastapi-ad5e0f9e084e 를 참고하세요.
```

#### ❖ EC2 공개 IPv4 확인

AWS 서비스 간 연결하더라도 같은 VPC 내 서비스를 이용하지 않으면 공개 IP를 사용해서 서로 통신을 해야합니다. 우리가 이용할 클라우드프론트는 글로벌 서비스이므로 VPC에 존재하는 EC2와는 공개 IP를 이용해서 통신이 가능합니다. 그러므로 연결할 EC2에서 공개 IP를 사용하고 있는지 확인하겠습니다.

EC2 옵션에서 공개 아이피 확인하는 방법 소개하는 이미지

#### ❖ 클라우드프론트 오리진(Origin) 생성

이제 클라우드프론트 페이지로 넘어가서 EC2와 클라우드프론트를 연결하는 방법을 설명하겠습니다. 앞서 언급했듯 이미 S3와 클라우드프론트가 연결된 상황에서 EC2를 추가하는 방법에 대해 설명할 예정입니다.

아래 화면은 연결 서비스의 구성을 세팅하는 페이지 입니다. 클라우드프론트에서 EC2를 사용하기 위해선 우선 오리진으로 서비스를 등록해야하므로 오리진 서비스에 EC2를 신규로 추가합니다.

EC2 인스턴스의 경우엔 목록에 자동으로 뜨지 않기 때문에 수동으로 서비스 명을 복사해서 붙여넣어야 합니다. EC2 설정에 들어가서 Public IPv4 DNS 주소를 복사해 붙여넣습니다.

프로토콜은 HTTP only로 설정합니다. 흐름 상 클라우드프론트가 HTTPS 통신을 담당하고 그 데이터를 EC2에 전달하는 방식이므로 클라우드프론트와 EC2는 HTTP 통신으로 연결되고 있습니다. 설정에서 HTTPS를 선택하면 클라우드프론트와 EC2 사이 통신이 불가하니 HTTP Only로 설정됐는지 다시 한 번 확인 바랍니다.

확인을 눌러 등록합니다.

#### ❖ 클라우드프론트 행동(Behavior) 생성

일반적으로 클라우드프론트를 사용하는 목적이 캐싱이지만, EC2와 클라우드프론트 연결에서는 캐시 기능을 사용하지 않는 것을 추천드립니다.(S3와 클라우드프론트 연결에는 캐시를 사용 할 예정이므로 이 부분이 우려되신다면 걱정하지 않으셔도 됩니다.) 구축 초기에 캐시 기능을 이용한 채로 서비스를 운영 해본 결과 많은 예상치 못한 오류의 원인이 캐시 기능에서 비롯했기 때문입니다. 정적 페이지만을 기반으로 서비스 한다면 클라우드프론트의 캐시를 사용해도 무방하지만, 동적 페이지 로딩이 필요한 서비스는 클라우드프론트가 아닌 서버에서 캐싱하는 방식이 좋은 접근법으로 보입니다.

> 프록시 역할을 수행 하는 거고 실제로 의 이런 기능들은 이제 없이 와이씨와의 그런 또 다른 연결을 통해서 진행이 됩니다 따라서 기본적으로 EC2에서는 공개 IP를 사용해야 합니다 아래 그림을 보시면 좀 더 명확하게 이해가 되실 텐데 일단 도메인는 사용하지 않는 상태 라고 가정했을 때 이런 구조 의 주소를 이용해서 클라우드프론트 접속을 하게 되면 클라우드프론트는 해당 세부 주소에 도로 이제 라우팅을 한다고 보시면 되겠습니다

넣어야 할 것들
클라우드프론트 행동 생성 - EC2를 기본으로 설정
S3와 연결 관계에서 주의할 점 설명

RDS EC2에만 연결하기
SSH 연결해서 사용 - SSH 연결 방법이 안된 경우 아래 블로그 글 참고
로컬에서 SSH 연결해서 사용하는 방법
